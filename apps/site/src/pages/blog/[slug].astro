---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navigation from '../../components/Navigation.astro';
import ThemeSwitcher from '../../components/ThemeSwitcher.astro';
import { getSiteData } from '../../utils/data';

// Server-side rendering - get data at request time
const data = await getSiteData();
const { profile, blogEnabled, blogPosts, colorTheme } = data;

if (!blogEnabled) {
  return Astro.redirect('/');
}

const slug = Astro.params.slug;
const post = blogPosts?.find(p => p.slug === slug && p.status === 'published');

if (!post) {
  return Astro.redirect('/blog');
}
---

<BaseLayout title={`${post.title} - ${profile.name || 'Portfolio'}`}>
  <ThemeSwitcher colorTheme={colorTheme || 'ocean'} />
  <Navigation profile={profile} blogEnabled={blogEnabled} />
  <main class="min-h-screen py-20">
    <div class="container mx-auto px-4">
      <article class="max-w-4xl mx-auto">
        <div class="mb-8">
          <a href="/blog" class="text-primary-600 dark:text-primary-400 hover:underline mb-4 inline-block">
            ← Back to Blog
          </a>
        </div>
        
        {post.featuredImage && (
          <img 
            src={post.featuredImage} 
            alt={post.title}
            class="w-full h-64 md:h-96 object-cover rounded-lg mb-8"
          />
        )}
        
        <header class="mb-8">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">{post.title}</h1>
          <div class="flex items-center gap-4 text-gray-500 dark:text-gray-400 mb-4">
            <time>{new Date(post.date).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}</time>
            {post.tags && post.tags.length > 0 && (
              <div class="flex gap-2">
                {post.tags.map(tag => (
                  <span class="px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200 rounded-full text-sm">
                    {tag}
                  </span>
                ))}
              </div>
            )}
          </div>
          {post.excerpt && (
            <p class="text-xl text-gray-600 dark:text-gray-300 leading-relaxed whitespace-pre-line">
              {post.excerpt}
            </p>
          )}
        </header>
        
        <div class="prose prose-lg dark:prose-invert max-w-none">
          <div class="whitespace-pre-line" set:html={post.content}></div>
        </div>
        
        <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-center">
            <a href="/blog" class="text-primary-600 dark:text-primary-400 hover:underline">
              ← Back to Blog
            </a>
            <a href="/#contact" class="text-primary-600 dark:text-primary-400 hover:underline">
              Get in Touch →
            </a>
          </div>
        </footer>
      </article>
    </div>
  </main>
</BaseLayout>